# =========================
# Script: Desativação Automática de Contas Expiradas no AD
# Autor: [Augusto Kalel - Kyndryl WMS TEAM]
# Data: [06-10-2025]
# =========================

# 1) Permitir execução do script
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
Set-ExecutionPolicy RemoteSigned -Scope Process -Force

# 2) Importar módulo do Active Directory
Import-Module ActiveDirectory

# 3) Preparar variáveis de data e caminho do relatório
$agora        = Get-Date
$dataAtual    = $agora.ToString("dd-MM-yyyy")
$arquivoSaida = "C:\Relatorio_Contas_Desativadas_$dataAtual.csv"

# 4) Definir as OUs a serem verificadas
$ouList = @(
    "OU=Maneja Facilities,OU=Suppliers,DC=REDERECORD,DC=com,DC=br"
)

# 5) Configuração de e-mail
$EmailTo    = @("conta1@empresa.com.br", "conta1@empresa.com.br", "conta1@empresa.com.br")
$EmailFrom  = "conta1@empresa.com.br"
$Subject    = "Relatório - Contas desativadas automaticamente"
$SMTPServer = "192.168.1.10"
$SMTPPort   = 25

# 6) Inicializar lista de contas desativadas
$desativadas = @()

# 7) Processar cada OU
foreach ($ouOrigem in $ouList) {
    Write-Host "`nVerificando OU: $ouOrigem" -ForegroundColor Cyan

    # Buscar usuários ativos com data de expiração anterior à data atual
    $contas = Get-ADUser -SearchBase $ouOrigem -SearchScope Subtree `
        -LDAPFilter "(&(objectClass=user)(!(objectClass=computer)))" `
        -Properties SamAccountName, Name, AccountExpirationDate, Enabled, DistinguishedName, info

    $contasExpiradas = $contas | Where-Object {
        $_.Enabled -eq $true -and
        $_.AccountExpirationDate -ne $null -and
        $_.AccountExpirationDate -lt $agora
    }

    if (-not $contasExpiradas -or $contasExpiradas.Count -eq 0) {
        Write-Host "Nenhuma conta ativa e expirada encontrada na OU $ouOrigem." -ForegroundColor Yellow
        continue
    }

    # 8) Desativar contas e atualizar campo 'info'
    foreach ($user in $contasExpiradas) {
        try {
            Disable-ADAccount -Identity $user.SamAccountName -ErrorAction Stop

            # Atualizar campo 'info' com nota de automação
            $notaAutomacao = "Conta desativada automaticamente em $($agora.ToString("dd/MM/yyyy HH:mm"))"
            $currentInfo   = $user.info

            if ([string]::IsNullOrWhiteSpace($currentInfo)) {
                $newInfo = $notaAutomacao
            } elseif ($currentInfo -notmatch [regex]::Escape($notaAutomacao)) {
                $newInfo = ($currentInfo.Trim() + "`r`n" + $notaAutomacao)
            } else {
                $newInfo = $currentInfo
            }

            Set-ADUser -Identity $user.SamAccountName -Replace @{info = $newInfo}

            # Adicionar ao relatório
            $ouPath = ($user.DistinguishedName -split ',', 2)[1]

            $desativadas += [PSCustomObject]@{
                Login         = $user.SamAccountName
                Nome          = $user.Name
                DataExpiracao = $user.AccountExpirationDate.ToString("dd/MM/yyyy HH:mm")
                OU            = $ouPath
                DesativadoEm  = $agora.ToString("dd/MM/yyyy HH:mm")
            }

            Write-Host "Conta desativada: $($user.SamAccountName)" -ForegroundColor Green
        }
        catch {
            Write-Host "Falha ao desativar $($user.SamAccountName): $($_.Exception.Message)" -ForegroundColor Red
        }
    }
}

# 9) Gerar relatório e enviar e-mail se houver desativações
if (-not $desativadas -or $desativadas.Count -eq 0) {
    Write-Host "`nNenhuma conta foi desativada com sucesso. Sem envio de e-mail." -ForegroundColor Yellow
    return
}

Write-Host "`n=== CONTAS DESATIVADAS (sucesso) ===" -ForegroundColor Cyan
$desativadas | Format-Table -AutoSize

# Exportar CSV
$desativadas | Export-Csv -Path $arquivoSaida -NoTypeInformation -Encoding UTF8
Write-Host "`nRelatório salvo em: $arquivoSaida" -ForegroundColor Green

# 10) Montar corpo HTML do e-mail
$tableHtml = $desativadas |
    Select-Object Login, Nome, DataExpiracao, OU, DesativadoEm |
    ConvertTo-Html -Fragment

$htmlBody = @"
<html>
<head>
<meta charset='UTF-8'>
<style>
    body { font-family: Segoe UI, Arial, sans-serif; color: #1a1a1a; }
    h2   { color: #0b5cad; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #cccccc; padding: 6px 8px; text-align: left; }
    th { background-color: #f2f2f2; }
</style>
</head>
<body>
    <h2>Contas desativadas automaticamente</h2>
    <p>Execução: <strong>$($agora.ToString("dd/MM/yyyy HH:mm"))</strong></p>
    <p>Total desativadas: <strong>$($desativadas.Count)</strong></p>
    $tableHtml
    <p style="margin-top:12px;">Relatório completo em anexo: <code>$([System.IO.Path]::GetFileName($arquivoSaida))</code></p>
</body>
</html>
"@

# 11) Enviar e-mail
try {
    Send-MailMessage `
        -From $EmailFrom `
        -To $EmailTo `
        -Subject $Subject `
        -Body $htmlBody `
        -BodyAsHtml `
        -SmtpServer $SMTPServer `
        -Port $SMTPPort `
        -Attachments $arquivoSaida `
        -Encoding UTF8

    Write-Host "E-mail enviado para $($EmailTo -join ', ') com o relatório em anexo e dados no corpo." -ForegroundColor Green
}
catch {
    Write-Host "Falha ao enviar e-mail: $($_.Exception.Message)" -ForegroundColor Red
}
